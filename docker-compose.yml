# WARNING: Default credentials below are for DEVELOPMENT ONLY.
# DO NOT use in production - override via environment variables or .env file.
services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-ntn}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ntnpass}
      POSTGRES_DB: ${POSTGRES_DB:-ntn_lbtools}
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "ntn"]
      interval: 5s
      retries: 5

  backend:
    image: ghcr.io/astral-sh/uv:0.8.11-python3.12-bookworm
    user: "${UID:-1000}:${GID:-1000}"
    working_dir: /app
    command:
      - uv
      - run
      - uvicorn
      - src.api.main:app
      - --host
      - 0.0.0.0
      - --port
      - "8000"
      - --reload
    volumes:
      - ./backend:/app
    env_file:
      - ./backend/.env
    environment:
      DATABASE_URL: postgresql+asyncpg://ntn:ntnpass@db:5432/ntn_lbtools
      UV_CACHE_DIR: /tmp/uv-cache
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')",
        ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  frontend:
    image: node:24.12.0
    user: "${UID:-1000}:${GID:-1000}"
    working_dir: /app
    command: ["sh", "-c", "corepack pnpm install && corepack pnpm dev --host 0.0.0.0 --port 5173"]
    volumes:
      - ./frontend:/app
    env_file:
      - ./frontend/.env
    environment:
      CI: "true"
      HOME: /home/node
      COREPACK_HOME: /home/node/.cache/corepack
    ports:
      - "5173:5173"

  mcp-server:
    image: ghcr.io/astral-sh/uv:0.8.11-python3.12-bookworm
    user: "${UID:-1000}:${GID:-1000}"
    working_dir: /app
    command:
      - uv
      - run
      - -m
      - src.main
    stdin_open: true
    tty: true
    volumes:
      - ./mcp-server:/app
    env_file:
      - ./mcp-server/.env
    environment:
      BACKEND_API_URL: http://backend:8000
      UV_CACHE_DIR: /tmp/uv-cache
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

  migrate:
    image: ghcr.io/astral-sh/uv:0.8.11-python3.12-bookworm
    user: "${UID:-1000}:${GID:-1000}"
    working_dir: /app
    command:
      - uv
      - run
      - alembic
      - upgrade
      - head
    volumes:
      - ./backend:/app
    env_file:
      - ./backend/.env
    environment:
      DATABASE_URL: postgresql+asyncpg://ntn:ntnpass@db:5432/ntn_lbtools
      UV_CACHE_DIR: /tmp/uv-cache
    depends_on:
      db:
        condition: service_healthy

volumes:
  pgdata:
    external: true
    name: backend_pgdata
